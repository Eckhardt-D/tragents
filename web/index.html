<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="/webui.js"></script>
  <title>Document</title>
</head>

<body>
  <h1>Tragents Beta</h1>
  <button id="close_app">CLOSE</button>
  <button onclick="getTicks()">GET TICKS</button>
  <div style="width: 800px; height: 400px;" id="container"></div>


  <script src="/charts.js"></script>
  <script>
    // Works when visiting the local server @ browser, but not in GTK webview :(
    const chartOptions = {layout: {textColor: 'black', background: {type: 'solid', color: 'white'}}};
    const chart = window.LightweightCharts.createChart(document.getElementById('container'), chartOptions);

    async function getTicks() {
      const response = await window.webui.get_ticks();
      const ticks = JSON.parse(response);

      const areaSeries = chart.addAreaSeries({
        lineColor: '#2962FF', topColor: '#2962FF',
        bottomColor: 'rgba(41, 98, 255, 0.28)',
      });

      const times = ticks.map((tick, i) => {
        const threeYearsMillis = 3 * 365 * 24 * 60 * 60 * 1000;
        const startingTimestamp = Date.now() - threeYearsMillis;
        const timestamp = startingTimestamp + (i * 1000);
        return Math.round(timestamp / 1000);
      });

      //const volumes = ticks.map((tick, i) => {
      //  return {
      //    time: times[i],
      //    value: tick.volume,
      //  }
      //});

      //areaSeries.setData(volumes);

      const candlestickSeries = chart.addCandlestickSeries({
        upColor: '#26a69a', downColor: '#ef5350', borderVisible: false,
        wickUpColor: '#26a69a', wickDownColor: '#ef5350',
      });

      const candles = ticks.map((tick, i) => {
        const float = (value) => parseFloat(value.toFixed(5));

        return {
          time: times[i],
          open: float(tick.open),
          high: float(tick.high),
          low: float(tick.low),
          close: float(tick.close),
        }
      });

      console.log(candles);

      candlestickSeries.setData(candles);
      chart.timeScale().fitContent();
    }
  </script>
</body>

</html>
